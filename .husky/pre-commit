#!/usr/bin/env sh
# Husky pre-commit hook (PowerShell compatible)

set -e

# Helper function to check if a script exists in package.json
script_exists() {
  npm run | grep -q "^$1"
}

echo "[Husky] Starting pre-commit hook..."

if script_exists "fix:all"; then
  echo "[Husky] Running fix:all..."
  if ! npm run fix:all; then
    echo "[Husky] fix:all failed. Checking for source-map syntax error..."

    # Check if the error is related to source-map syntax issue in the log file
    if grep -q "import ArraySet from.*SyntaxError" ./convert-require-to-import.log 2>/dev/null; then
      echo "[Husky] Detected source-map syntax error. Running autofix-errors script..."

      # Run autofix script that cleans corrupted packages and reinstalls dependencies
      if npm run autofix-errors; then
        echo "[Husky] Autofix complete. Please re-run your git commit."
      else
        echo "[Husky] Autofix failed. Please manually delete node_modules and reinstall."
      fi

      exit 1
    fi

    echo "[Husky] fix:all failed due to other reasons. Aborting commit."
    exit 1
  fi
else
  echo "[Husky] Warning: fix:all script not found, skipping."
fi

echo "[Husky] Running qmoi:always-fix-all..."
npm run qmoi:always-fix-all || {
  echo "[Husky] Error: qmoi:always-fix-all failed. Aborting commit."
  exit 1
}

echo "[Husky] Running pre-activity check..."
node scripts/qmoi_pre_activity_check.js || {
  echo "[Husky] Error: QMOI pre-activity check failed. Aborting commit."
  exit 1
}

echo "[Husky] Running lint..."
npm run lint || {
  echo "[Husky] Error: Lint failed. Aborting commit."
  exit 1
}

echo "[Husky] Running tests..."
npm test || {
  echo "[Husky] Error: Tests failed. Aborting commit."
  exit 1
}

echo "[Husky] Running QMOI doc verifier..."
node scripts/qmoi_doc_verifier.js verify || {
  echo "[Husky] Error: QMOI doc verifier failed. Aborting commit."
  exit 1
}

echo "[Husky] Adding changes to git..."
git add .

echo "[Husky] Pre-commit hook completed successfully."
