name: Update Analytics Dashboard

on:
  workflow_run:
    workflows: ["E2E Tests"]
    types:
      - completed

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Post test results to dashboard API
        run: |
          if [ -f coverage/summary.json ]; then
            curl -X POST https://dashboard.example.com/api/test-results \
              -H "Authorization: Bearer ${{ secrets.DASHBOARD_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d @coverage/summary.json
          else
            echo "No summary.json found, skipping dashboard update."
          fi 
      - name: Send test results to Datadog
        if: ${{ hashFiles('coverage/summary.json') != '' }}
        run: |
          curl -X POST "https://api.datadoghq.com/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d @coverage/summary.json
      - name: Send test event to Google Analytics
        if: ${{ hashFiles('coverage/summary.json') != '' }}
        run: |
          curl -X POST "https://www.google-analytics.com/mp/collect?measurement_id=${{ secrets.GA_MEASUREMENT_ID }}&api_secret=${{ secrets.GA_API_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{"client_id":"ci-pipeline","events":[{"name":"ci_test_run","params":{"result":"success"}}]}' 