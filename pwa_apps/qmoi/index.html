<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>QMOI</title>
    <link rel="manifest" href="/mirror/raw/pwa_apps/qmoi/manifest.webmanifest">
    <style>body{font-family:system-ui,Arial,sans-serif;padding:16px;background:#f7f9fc}header{display:flex;align-items:center;gap:12px}h1{margin:0}</style>
  </head>
  <body>
    <header>
      <h1>QMOI</h1>
      <small>Core assistant experience</small>
    </header>
    <p>QMOI provides assistant features, dialog, and integrations. This embedded view connects to the control server for auth and AI requests.</p>
    <section id="auth">
      <h3>Sign in</h3>
      <input id="li-username" placeholder="username" />
      <input id="li-password" placeholder="password" type="password" />
      <button id="li-btn">Login</button>
      <div id="who">Not logged in</div>
    </section>

    <section id="assistant" style="display:none">
      <h3>Assistant</h3>
      <textarea id="prompt" rows="4" cols="50" placeholder="Ask QMOI..."></textarea><br>
      <button id="ask">Ask</button>
      <pre id="airesp">(no response)</pre>
      <h4>Memory (q.ki)</h4>
      <pre id="memory">(not loaded)</pre>
    </section>

    <script>
      function _setToken(t){ localStorage.setItem('qmoi_token', t); document.getElementById('who').innerText='Logged in'; document.getElementById('assistant').style.display='block'; loadMemory(); }
      function _clearToken(){ localStorage.removeItem('qmoi_token'); document.getElementById('who').innerText='Not logged in'; document.getElementById('assistant').style.display='none'; }
      document.getElementById('li-btn').addEventListener('click', async ()=>{
        const u = document.getElementById('li-username').value;
        const p = document.getElementById('li-password').value;
        const res = await fetch(window.location.origin + '/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
        if (res.ok){ const j = await res.json(); _setToken(j.token); startAutosync(); } else { alert('Login failed'); }
      });

      document.getElementById('ask').addEventListener('click', async ()=>{
        const t = localStorage.getItem('qmoi_token'); if (!t){ alert('login required'); return; }
        const prompt = document.getElementById('prompt').value;
        const res = await fetch(window.location.origin + '/ai', {method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+t}, body: JSON.stringify({prompt})});
        if (res.ok){ const j = await res.json(); document.getElementById('airesp').innerText = JSON.stringify(j.response, null, 2); } else { alert('AI request failed'); }
      });

      async function loadMemory(){ const t = localStorage.getItem('qmoi_token'); if (!t) return; try{ const res = await fetch(window.location.origin + '/memories', {headers:{'Authorization':'Bearer '+t}}); if (res.ok){ const j = await res.json(); const m = (j.memories||[]).find(x=>x.key==='q.ki'); document.getElementById('memory').innerText = m ? JSON.stringify(m, null, 2) : '(no q.ki)'; }}catch(e){} }

      // Autosync reused from Q Alpha
      let autosyncIntervalId = null;
      function startAutosync(){ if (!autosyncIntervalId){ autosyncIntervalId = setInterval(async ()=>{ const t = localStorage.getItem('qmoi_token'); if (!t) return; const local = JSON.parse(localStorage.getItem('qmoi_memories')||'[]'); try{ await fetch(window.location.origin + '/sync-memory', {method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+t}, body: JSON.stringify({memories: local})}); const r = await fetch(window.location.origin + '/memories', {headers:{'Authorization':'Bearer '+t}}); if (r.ok){ const j = await r.json(); localStorage.setItem('qmoi_memories', JSON.stringify(j.memories||[])); loadMemory(); }}catch(e){ console.log('autosync err', e); } }, 30000); } }
      function stopAutosync(){ if (autosyncIntervalId){ clearInterval(autosyncIntervalId); autosyncIntervalId = null; } }

      // initialize if token present
      if (localStorage.getItem('qmoi_token')){ _setToken(localStorage.getItem('qmoi_token')); startAutosync(); }
    </script>
  </body>
</html>
